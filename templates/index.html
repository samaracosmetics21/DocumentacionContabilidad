{% extends "base.html" %}

{% block title %}Registro de Facturas{% endblock %}

{% block banner %}
<div class="banner">Registro de Facturas</div>
{% endblock %}

{% block content %}
        <div class="card">
            <div class="card-header">Registro de Facturas</div>
            <div class="card-body form-container">
                <form id="formulario-factura" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="nit" class="form-label">NIT</label>
                        <input type="text" id="nit" name="nit" class="form-control" placeholder="Ingrese el NIT" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre</label>
                        <input type="text" id="nombre" name="nombre" class="form-control" placeholder="Escribe el nombre del cliente" oninput="buscarClientes()" required>
                    </div>
                    <div id="sugerencias" class="list-group" style="max-height: 200px; overflow-y: auto; display: none;"></div>
                    <div class="mb-3">
                        <label for="numero_factura" class="form-label">Número de Factura</label>
                        <input type="text" id="numero_factura" name="numero_factura" class="form-control" required style="text-transform: uppercase;">
                    </div>
                    <div class="mb-3">
                        <label for="fecha" class="form-label">Fecha</label>
                        <input type="date" id="fecha" name="fecha" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="clasificacion" class="form-label">Clasificación</label>
                        <select id="clasificacion" name="clasificacion" class="form-select" required>
                            <option value="1">Facturas M.P (producción)</option>
                            <option value="2">Facturas Servicios (compras)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="archivo" class="form-label">Subir Archivo</label>
                        <input type="file" id="archivo" name="archivo" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea id="observaciones" name="observaciones" class="form-control" rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Registrar</button>
                </form>
            </div>
        </div>
         
        <div class="card mt-4">
            <div class="card-header bg-warning text-dark">Editar Factura</div>
            <div class="card-body form-container">
                <div class="mb-3">
                    <label for="buscar_id" class="form-label">Buscar por ID</label>
                    <div class="input-group">
                        <input type="number" id="buscar_id" class="form-control" placeholder="ID de la factura">
                        <button type="button" class="btn btn-secondary" onclick="buscarFacturaPorID()">Buscar</button>
                    </div>
                </div>
        
                <form id="formulario-edicion" enctype="multipart/form-data" style="display: none;">
                    <input type="hidden" id="edit_id" name="id">
        
                    <div class="mb-3">
                        <label for="edit_nit" class="form-label">NIT</label>
                        <input type="text" id="edit_nit" name="nit" class="form-control" readonly>
                    </div>
        
                    <div class="mb-3">
                        <label for="edit_nombre" class="form-label">Nombre</label>
                        <input type="text" id="edit_nombre" name="nombre" class="form-control" oninput="buscarClientesEdicion()" required>
                    </div>
        
                    <div id="sugerencias_edicion" class="list-group" style="max-height: 200px; overflow-y: auto; display: none;"></div>
        
                    <div class="mb-3">
                        <label for="edit_numero_factura" class="form-label">Número de Factura</label>
                        <input type="text" id="edit_numero_factura" name="numero_factura" class="form-control" required>
                    </div>
        
                    <div class="mb-3">
                        <label for="edit_fecha" class="form-label">Fecha</label>
                        <input type="date" id="edit_fecha" name="fecha" class="form-control" required>
                    </div>
        
                    <div class="mb-3">
                        <label for="edit_clasificacion" class="form-label">Clasificación</label>
                        <select id="edit_clasificacion" name="clasificacion" class="form-select" required>
                            <option value="1">Facturas M.P (producción)</option>
                            <option value="2">Facturas Servicios (compras)</option>
                        </select>
                    </div>
        
                    <div class="mb-3">
                        <label for="edit_archivo" class="form-label">Actualizar Archivo (opcional)</label>
                        <input type="file" id="edit_archivo" name="archivo" class="form-control">
                    </div>
        
                    <div class="mb-3">
                        <label for="edit_observaciones" class="form-label">Observaciones</label>
                        <textarea id="edit_observaciones" name="observaciones" class="form-control" rows="4"></textarea>
                    </div>
        
                    <button type="submit" class="btn btn-primary">Actualizar Factura</button>
                </form>
            </div>
        </div>
        
        <div class="footer-text">
            <small>&copy; 2025 Sistema de Gestión Documental</small>
        </div>
{% endblock %}

{% block extra_js %}
    <script>
        function buscarClientes() {
            let nombre = document.getElementById("nombre").value.trim();
            let nit = document.getElementById("nit").value.trim();
            let query = nombre.length >= 3 ? nombre : nit;

            if (query.length >= 3) {
                $.ajax({
                    url: '/buscar_cliente',
                    type: 'GET',
                    data: { q: query },
                    success: function(response) {
                        const sugerencias = document.getElementById("sugerencias");
                        sugerencias.innerHTML = "";
                        if (response.length > 0) {
                            sugerencias.style.display = "block";
                            response.forEach(cliente => {
                                const div = document.createElement("div");
                                div.classList.add("list-group-item");
                                div.textContent = cliente.nombre.trim();
                                div.onclick = function() {
                                    document.getElementById("nombre").value = cliente.nombre.trim();
                                    document.getElementById("nit").value = cliente.nit.trim();
                                    sugerencias.style.display = "none";
                                };
                                sugerencias.appendChild(div);
                            });
                        } else {
                            sugerencias.style.display = "none";
                        }
                    },
                    error: function() {
                        alert("Error al realizar la búsqueda. Intente nuevamente.");
                    }
                });
            } else {
                document.getElementById("sugerencias").style.display = "none";
            }
        }

        document.getElementById("formulario-factura").addEventListener("submit", function(e) {
            e.preventDefault();

            if (!confirm("¿Estás seguro de aprobar esta factura? Esta acción no se puede deshacer.")) return;

            const formData = new FormData(this);

            fetch("/", {
                method: "POST",
                body: formData
            })
            .then(res => {
                if (!res.ok) return res.json().then(err => { throw err; });
                return res.json();
            })
            .then(data => {
                if (data.success) {
                    alert("✅ Factura registrada exitosamente.");
                    location.reload();
                } else {
                    alert("❌ No se pudo guardar la factura:\n" + data.message);
                }
            })
            .catch(err => {
                console.error("Error al guardar factura:", err);
                alert("❌ Error inesperado:\n" + (err.message || JSON.stringify(err)));
            });
        });

        function buscarFacturaPorID() {
            const id = document.getElementById("buscar_id").value.trim();
            if (!id) {
                alert("Ingrese un ID válido");
                return;
            }

            fetch(`/buscar_factura?id=${id}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        alert("❌ " + data.error);
                        return;
                    }

                    document.getElementById("edit_id").value = data.id;
                    document.getElementById("edit_nit").value = data.nit;
                    document.getElementById("edit_nombre").value = data.nombre;
                    document.getElementById("edit_numero_factura").value = data.numero_factura;
                    document.getElementById("edit_fecha").value = data.fecha_seleccionada;
                    document.getElementById("edit_clasificacion").value = data.clasificacion;
                    document.getElementById("edit_observaciones").value = data.observaciones_regis;

                    document.getElementById("formulario-edicion").style.display = "block";
                })
                .catch(err => {
                    alert("Error al buscar la factura");
                    console.error(err);
                });
        }

        function buscarClientesEdicion() {
            const nombre = document.getElementById("edit_nombre").value.trim();
            if (nombre.length < 3) {
                document.getElementById("sugerencias_edicion").style.display = "none";
                return;
            }

            $.ajax({
                url: '/buscar_cliente',
                type: 'GET',
                data: { q: nombre },
                success: function(response) {
                    const sugerencias = document.getElementById("sugerencias_edicion");
                    sugerencias.innerHTML = "";
                    if (response.length > 0) {
                        sugerencias.style.display = "block";
                        response.forEach(cliente => {
                            const div = document.createElement("div");
                            div.classList.add("list-group-item");
                            div.textContent = cliente.nombre.trim();
                            div.onclick = function() {
                                document.getElementById("edit_nombre").value = cliente.nombre.trim();
                                document.getElementById("edit_nit").value = cliente.nit.trim();
                                sugerencias.style.display = "none";
                            };
                            sugerencias.appendChild(div);
                        });
                    } else {
                        sugerencias.style.display = "none";
                    }
                },
                error: function() {
                    alert("Error al buscar cliente");
                }
            });
        }

        document.getElementById("formulario-edicion").addEventListener("submit", function(e) {
            e.preventDefault();

            if (!confirm("¿Deseas actualizar esta factura?")) return;

            const formData = new FormData(this);

            const clasificacionValor = this.querySelector("#edit_clasificacion").value;
            let clasificacionTexto = "";

            if (clasificacionValor === "1") {
                clasificacionTexto = "Facturas M.P (producción)";
            } else if (clasificacionValor === "2") {
                clasificacionTexto = "Facturas Servicios (compras)";
            } else {
                clasificacionTexto = clasificacionValor;
            }

            formData.set("clasificacion", clasificacionTexto);

            fetch("/actualizar_factura", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("✅ Factura actualizada correctamente.");
                    location.reload();
                } else {
                    alert("❌ Error al actualizar:\n" + (data.error || "Error desconocido"));
                }
            })
            .catch(err => {
                console.error(err);
                alert("❌ Error inesperado");
            });
        });
    </script>
{% endblock %}
