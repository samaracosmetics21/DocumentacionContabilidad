{% extends "base.html" %}

{% block title %}Gestión de Bodega{% endblock %}

{% block extra_css %}
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">
    <!-- FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn-loading {
            position: relative;
            pointer-events: none;
        }
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .alert-dynamic {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <!-- Header mejorado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-warehouse"></i> Gestión de Bodega</h2>
            <div>
                <span class="badge bg-primary">{{ grupo_usuario }}</span>
            </div>
        </div>

        <!-- Mensajes de flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert alert-{{ messages[0][0] }}">
                {{ messages[0][1] }}
            </div>
        {% endif %}
        {% endwith %}
        
        <!-- Alertas dinámicas -->
        <div id="alert-container"></div>
        
        <div class="card">
            <div class="card-body">
                <!-- Formulario convertido a AJAX -->
                <div id="bodega-form">
                    <input type="hidden" name="usuario_id" id="usuario_id" value="{{ session['user_id'] }}">
        
                    <div class="mb-4">
                        <label for="search" class="form-label">Buscar Factura:</label>
                        <input type="text" id="search" class="form-control" placeholder="Filtro de busqueda...">
                    </div>
                    <table class="table table-striped table-bordered" id="facturasTable">
                        <thead>
                            <tr>
                                <th>ID Orden</th>
                                <th>Producto OC</th>
                                <th>Cliente OC</th>
                                <th>Cantidad OC</th>
                                <th>Estado OC</th>
                                <th>Factura</th>
                                <th>Referencia</th>
                                <th>Lote</th>
                                <th>Archivo</th>  <!-- Nueva columna "Archivo" -->
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for orden in ordenes_compras %}
                            <tr data-orden-id="{{ orden[0] }}">
                                <td>{{ orden[0] }}</td>
                                <td>{{ orden[2] }}</td>
                                <td>{{ orden[3] }}</td>
                                <td>{{ orden[4] }}</td>
                                <td>
                                    {% if orden[5] == 'Pendiente' %}
                                        <span class="badge bg-warning">Pendiente</span>
                                    {% else %}
                                        <span class="badge bg-success">Aprobada</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <select name="factura_id_{{ orden[0] }}" class="form-control">
                                        <option value="">Seleccione una factura</option>
                                        {% for factura in facturas_pendientes[orden[0]] %}
                                            <option value="{{ factura[0] }}">{{ factura[1] }} - {{ factura[2] }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <div>
                                        {% for referencia_numero, referencia_nombre in referencias[orden[2]].items() %}
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" name="referencias_oc_{{ orden[0] }}" value="{{ referencia_numero }}" id="referencia_{{ orden[0] }}_{{ referencia_numero }}" onclick="mostrarLotes('{{ orden[0] }}', '{{ referencia_numero }}')">
                                                <label class="form-check-label" for="referencia_{{ orden[0] }}_{{ referencia_numero }}">
                                                    {{ referencia_numero }} - {{ referencia_nombre }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td>
                                    <div id="lotes_{{ orden[0] }}"></div>
                                </td>
                                <td>
                                    {% if orden[6] %}
                                        <a href="{{ url_for('static', filename='uploads/' + orden[6].replace('\\', '/')) }}" target="_blank" class="btn btn-link">Ver Archivo</a>
                                    {% else %}
                                        <span>No disponible</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <!-- ① Aprobar Seleccionadas - AJAX -->
                                    <button type="button" 
                                    class="btn btn-success btn-sm mt-3" 
                                    onclick="aprobarFactura({{ orden[0] }})"
                                    id="btn-aprobar-{{ orden[0] }}">
                                    <span class="badge bg-light text-dark rounded-circle me-1">1</span> 
                                    <i class="fas fa-link"></i> Vincular Lotes
                                    </button>
        
                                    <!-- Cerrar Factura - AJAX -->
                                    <button type="button" 
                                    class="btn btn-warning btn-sm mt-3" 
                                    onclick="cerrarFactura({{ orden[0] }})"
                                    id="btn-cerrar-factura-{{ orden[0] }}">
                                    <span class="badge bg-light text-dark rounded-circle me-1">2</span> 
                                    <i class="fas fa-times-circle"></i> Cerrar Factura
                                    </button>
        
                                    <!-- Cerrar Orden Compra - AJAX -->
                                    <button type="button" 
                                    class="btn btn-danger btn-sm mt-3" 
                                    onclick="cerrarOrden({{ orden[0] }})"
                                    id="btn-cerrar-orden-{{ orden[0] }}">
                                    <span class="badge bg-light text-dark rounded-circle me-1">3</span> 
                                    <i class="fas fa-ban"></i> Cerrar OC
                                    </button>
        
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            </div>
        </div>   
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
    <script>
        // Variables globales
        let table;
        
        // Función para mostrar alertas dinámicas
        function mostrarAlerta(mensaje, tipo = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert alert-${tipo} alert-dismissible fade show alert-dynamic" role="alert">
                    <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Función para mostrar loading en botones
        function mostrarLoading(buttonId) {
            const btn = document.getElementById(buttonId);
            if (btn) {
                btn.classList.add('btn-loading');
                btn.disabled = true;
            }
        }
        
        // Función para ocultar loading en botones
        function ocultarLoading(buttonId) {
            const btn = document.getElementById(buttonId);
            if (btn) {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }
        
        // Función AJAX para aprobar factura
        function aprobarFactura(ordenId) {
            if (!confirm("¿Estás seguro de aprobar los lotes y referencias? Esta acción no cerrará la factura.")) {
                return;
            }
            
            const facturaSelect = document.querySelector(`select[name="factura_id_${ordenId}"]`);
            if (!facturaSelect || !facturaSelect.value) {
                mostrarAlerta("Debes seleccionar una factura para aprobar", 'danger');
                return;
            }
            
            // Recoger referencias y lotes
            const referencias = [];
            const lotes = [];
            
            const referenciasCheckboxes = document.querySelectorAll(`input[name="referencias_oc_${ordenId}"]:checked`);
            referenciasCheckboxes.forEach(checkbox => {
                referencias.push(checkbox.value);
                const loteInput = document.querySelector(`input[name="lotes_${ordenId}_${checkbox.value}"]`);
                lotes.push(loteInput ? loteInput.value : '');
            });
            
            const data = {
                orden_id: ordenId,
                factura_id: facturaSelect.value,
                referencias: referencias,
                lotes: lotes
            };
            
            mostrarLoading(`btn-aprobar-${ordenId}`);
            
            fetch('/bodega/aprobar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                ocultarLoading(`btn-aprobar-${ordenId}`);
                if (result.success) {
                    mostrarAlerta(result.message, 'success');
                    // Actualizar la fila visualmente
                    actualizarFila(ordenId, 'aprobada');
                } else {
                    mostrarAlerta(result.message, 'danger');
                }
            })
            .catch(error => {
                ocultarLoading(`btn-aprobar-${ordenId}`);
                mostrarAlerta('Error de conexión: ' + error.message, 'danger');
            });
        }
        
        // Función AJAX para cerrar factura
        function cerrarFactura(ordenId) {
            if (!confirm("¿Estás seguro de cerrar la factura? Esta acción es irreversible.")) {
                return;
            }
            
            const facturaSelect = document.querySelector(`select[name="factura_id_${ordenId}"]`);
            if (!facturaSelect || !facturaSelect.value) {
                mostrarAlerta("Debes seleccionar una factura para cerrar", 'danger');
                return;
            }
            
            const data = {
                factura_id: facturaSelect.value
            };
            
            mostrarLoading(`btn-cerrar-factura-${ordenId}`);
            
            fetch('/bodega/cerrar_factura', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                ocultarLoading(`btn-cerrar-factura-${ordenId}`);
                if (result.success) {
                    mostrarAlerta(result.message, 'success');
                    // Actualizar la fila visualmente
                    actualizarFila(ordenId, 'factura_cerrada');
                } else {
                    mostrarAlerta(result.message, 'danger');
                }
            })
            .catch(error => {
                ocultarLoading(`btn-cerrar-factura-${ordenId}`);
                mostrarAlerta('Error de conexión: ' + error.message, 'danger');
            });
        }
        
        // Función AJAX para cerrar orden
        function cerrarOrden(ordenId) {
            if (!confirm("¿Estás seguro de cerrar esta orden de compra?")) {
                return;
            }
            
            const data = {
                orden_id: ordenId
            };
            
            mostrarLoading(`btn-cerrar-orden-${ordenId}`);
            
            fetch('/bodega/cerrar_orden', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                ocultarLoading(`btn-cerrar-orden-${ordenId}`);
                if (result.success) {
                    mostrarAlerta(result.message, 'success');
                    // Actualizar la fila visualmente
                    actualizarFila(ordenId, 'orden_cerrada');
                } else {
                    mostrarAlerta(result.message, 'danger');
                }
            })
            .catch(error => {
                ocultarLoading(`btn-cerrar-orden-${ordenId}`);
                mostrarAlerta('Error de conexión: ' + error.message, 'danger');
            });
        }
        
        // Función para actualizar la fila visualmente
        function actualizarFila(ordenId, accion) {
            const fila = document.querySelector(`tr[data-orden-id="${ordenId}"]`);
            if (!fila) return;
            
            // Actualizar estado visual según la acción
            if (accion === 'aprobada') {
                // Cambiar color de la fila o agregar indicador
                fila.style.backgroundColor = '#d4edda';
            } else if (accion === 'factura_cerrada') {
                fila.style.backgroundColor = '#fff3cd';
            } else if (accion === 'orden_cerrada') {
                fila.style.backgroundColor = '#f8d7da';
                // Deshabilitar botones
                const botones = fila.querySelectorAll('button');
                botones.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-50');
                });
            }
        }
        
        // Inicialización de DataTable
        $(document).ready(function() {
            table = $('#facturasTable').DataTable({
                paging: true,
                searching: true,
                lengthChange: false,
                pageLength: 10,
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.1/i18n/Spanish.json'
                }
            });

            $('#search').on('keyup', function() {
                table.search(this.value).draw();
            });
        });
        
        // Función para manejar los lotes dinámicamente
        $("input[name^='referencias_oc_']").on("change", function() {
            var ordenId = $(this).data("orden-id");
            var numeroReferencia = $(this).data("referencia-numero");
            var loteContainer = $("#lotes_" + ordenId);

            if ($(this).is(":checked")) {
                loteContainer.append(
                    '<div class="mb-2" id="lote-container-' + ordenId + '-' + numeroReferencia + '">' +
                        '<label for="lote_' + ordenId + '_' + numeroReferencia + '">Lote de ' + numeroReferencia + ':</label>' +
                        '<input type="text" name="lote_' + ordenId + '_' + numeroReferencia + '" class="form-control" placeholder="Ingrese lote" id="lote_' + ordenId + '_' + numeroReferencia + '">' +
                    '</div>'
                );
            } else {
                $("#lote-container-" + ordenId + "-" + numeroReferencia).remove();
            }
        });

        // Función para mostrar los lotes dinámicamente
        function mostrarLotes(orden_id, referencia_numero) {
            let lotesDiv = document.getElementById("lotes_" + orden_id);
            lotesDiv.innerHTML = "";

            let referenciasSeleccionadas = document.querySelectorAll("input[name='referencias_oc_" + orden_id + "']:checked");
            
            referenciasSeleccionadas.forEach(function(referenciaCheckbox) {
                let referencia_numero = referenciaCheckbox.value;

                let referenciaLabel = document.createElement("label");
                referenciaLabel.textContent = "Referencia: " + referencia_numero;
                referenciaLabel.classList.add("form-label");
                lotesDiv.appendChild(referenciaLabel);

                let inputLote = document.createElement("input");
                inputLote.type = "text";
                inputLote.name = "lotes_" + orden_id + "_" + referencia_numero;
                inputLote.placeholder = "Ingrese lote para referencia " + referencia_numero;
                inputLote.classList.add("form-control");
                lotesDiv.appendChild(inputLote);
            });
        }
    </script>
{% endblock %}
